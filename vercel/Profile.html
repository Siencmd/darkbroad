<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0a1929" />
    <title>Profile - Darkboard</title>
    <link rel="stylesheet" href="Darkboard.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Main Navigation - Horizontal for All -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <div class="nav-header">
        <a href="index.html" class="brand">DARKBOARD</a>
      </div>
      <ul class="nav-list">
        <li><a href="index.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a></li>
        <li><a href="Subjects.html" class="nav-item"><i class="fas fa-book"></i><span>Subjects</span></a></li>
        <li><a href="Grades.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Grades</span></a></li>
        <li><a href="Schedule.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a></li>
        <li><a href="Announcements.html" class="nav-item"><i class="fas fa-bell"></i><span>Announcements</span></a></li>
        <li><a href="Submissions.html" class="nav-item"><i class="fas fa-file-upload"></i><span>Submissions</span></a></li>
        <li><a href="Profile.html" class="nav-item active"><i class="fas fa-user"></i><span>Profile</span></a></li>
        <li><a href="Settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        <li><a href="Help.html" class="nav-item"><i class="fas fa-question-circle"></i><span>Help</span></a></li>
        <li><a href="#" id="logoutBtn" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
      </ul>
      <div class="nav-right">
        <div class="user-menu-right">
          <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="User avatar" class="user-avatar">
          <span id="headerUserName">Loading...</span>
        </div>
      </div>
      <div class="top-user-name" id="topUserName"></div>
    </nav>

    <!-- Main Content -->
    <main class="content">
      <section class="profile-section">
        <div class="profile-container">
          <!-- Profile Card -->
          <div class="profile-card">
            <div class="profile-picture">
              <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="Profile Picture">
            </div>
            <div class="profile-name-section">
              <h1 id="fullName">Loading...</h1>
              <p class="profile-role" id="displayRole">Student</p>
              <p class="profile-id" id="displayCourse">Course: ---</p>
              <button class="edit-profile-btn" id="editProfileBtn">
                <i class="fas fa-edit"></i> Edit Profile
              </button>
            </div>
          </div>

          <div class="profile-content">
            <div class="profile-section-left">
              <div class="detail-group">
                <h3>Personal Information</h3>
                <div class="detail-row">
                  <span class="detail-label">Full Name:</span>
                  <span class="detail-value" id="fullNameDisplay">Loading...</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value" id="infoEmail">Loading...</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value" id="infoPhone">Not set</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Date of Birth:</span>
                  <span class="detail-value" id="infoDOB">Not set</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Gender:</span>
                  <span class="detail-value" id="infoGender">Not set</span>
                </div>
              </div>

              <div class="detail-group">
                <h3>Academic Information</h3>
                <div class="detail-row">
                  <span class="detail-label">Course:</span>
                  <span class="detail-value" id="infoCourse">Loading...</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Role:</span>
                  <span class="detail-value" id="infoRole">Student</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Account Status:</span>
                  <span class="detail-value"><span class="status-active">Active</span></span>
                </div>
              </div>
            </div>
            <div class="profile-section-right">
              <!-- Additional profile widgets can go here -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
      <div class="modal-content">
        <span class="close" id="closeModalBtn">&times;</span>
        <div class="modal-body">
          <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
          <form id="editForm">
            <div class="form-group">
              <label for="editName">Full Name</label>
              <input type="text" id="editName" placeholder="Your full name" />
            </div>
            <div class="form-group">
              <label for="editEmail">Email</label>
              <input type="email" id="editEmail" placeholder="your.email@example.com" />
            </div>
            <div class="form-group">
              <label for="editPhone">Phone Number</label>
              <input type="tel" id="editPhone" placeholder="+1 234 567 890" />
            </div>
            <div class="form-group">
              <label for="editDOB">Date of Birth</label>
              <input type="date" id="editDOB" />
            </div>
            <div class="form-group">
              <label for="editGender">Gender</label>
              <select id="editGender">
                <option value="">Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
                <option value="Prefer not to say">Prefer not to say</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-save">
                <i class="fas fa-save"></i> Save Changes
              </button>
              <button type="button" class="btn-cancel" id="cancelModalBtn">
                <i class="fas fa-times"></i> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script type="module" src="firebase.js"></script>
    <script type="module" src="script.js"></script>
    <script type="module">
      import { logout } from "./script.js";
      import { auth, db } from "./firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      const logoutBtn = document.getElementById("logoutBtn");
      logoutBtn.addEventListener("click", (e) => logout(e));
      
      let profileRealtimeUnsubscribe = null;

      // Load user data on page load
      window.addEventListener('DOMContentLoaded', () => {
        loadUserProfileData();
        setupProfileRealtime();
      });

      function setupProfileRealtime() {
        onAuthStateChanged(auth, (user) => {
          if (!user) return;

          if (typeof profileRealtimeUnsubscribe === 'function') {
            profileRealtimeUnsubscribe();
            profileRealtimeUnsubscribe = null;
          }

          profileRealtimeUnsubscribe = onSnapshot(doc(db, 'users', user.uid), (userSnap) => {
            if (!userSnap.exists()) return;
            const profile = userSnap.data() || {};

            const localUserData = JSON.parse(localStorage.getItem('userData') || '{}');
            const localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');

            const mergedUserData = {
              ...localUserData,
              id: user.uid,
              name: profile.fullName || localUserData.name || user.displayName || 'User',
              role: profile.role || localUserData.role,
              course: profile.course || localUserData.course,
              email: profile.email || localUserData.email
            };

            const mergedProfile = {
              ...localProfile,
              fullName: profile.fullName || localProfile.fullName || mergedUserData.name,
              email: profile.email || localProfile.email || mergedUserData.email,
              phone: profile.phone || localProfile.phone,
              dob: localProfile.dob,
              gender: localProfile.gender
            };

            localStorage.setItem('userData', JSON.stringify(mergedUserData));
            localStorage.setItem('userProfile', JSON.stringify(mergedProfile));
            loadUserProfileData();
          }, (error) => {
            console.warn('Profile realtime sync failed:', error?.message || error);
          });
        });
      }

      window.addEventListener('beforeunload', () => {
        if (typeof profileRealtimeUnsubscribe === 'function') {
          profileRealtimeUnsubscribe();
          profileRealtimeUnsubscribe = null;
        }
      });
      
      function loadUserProfileData() {
        const userData = JSON.parse(localStorage.getItem('userData'));
        const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
        
        if (userData) {
          // Update header username
          const headerUserName = document.getElementById('headerUserName');
          if (headerUserName) {
            headerUserName.textContent = userData.name || 'User';
          }
          
          // Update profile name
          const fullName = document.getElementById('fullName');
          const fullNameDisplay = document.getElementById('fullNameDisplay');
          const name = savedProfile.fullName || userData.name || 'User';
          if (fullName) fullName.textContent = name;
          if (fullNameDisplay) fullNameDisplay.textContent = name;
          
          // Update email
          const email = document.getElementById('infoEmail');
          const editEmail = document.getElementById('editEmail');
          const userEmail = savedProfile.email || userData.email || 'Not set';
          if (email) email.textContent = userEmail;
          if (editEmail) editEmail.value = userEmail !== 'Not set' ? userEmail : '';
          
          // Update phone
          const phone = document.getElementById('infoPhone');
          const editPhone = document.getElementById('editPhone');
          const phoneVal = savedProfile.phone || userData.phone || 'Not set';
          if (phone) phone.textContent = phoneVal;
          if (editPhone) editPhone.value = phoneVal !== 'Not set' ? phoneVal : '';
          
          // Update course
          const course = document.getElementById('infoCourse');
          const displayCourse = document.getElementById('displayCourse');
          const courseVal = userData.course || 'Not set';
          if (course) course.textContent = courseVal;
          if (displayCourse) displayCourse.textContent = 'Course: ' + courseVal;
          
          // Update role
          const role = document.getElementById('infoRole');
          const displayRole = document.getElementById('displayRole');
          const roleVal = userData.role || 'student';
          const roleDisplay = roleVal.charAt(0).toUpperCase() + roleVal.slice(1);
          if (role) role.textContent = roleDisplay;
          if (displayRole) displayRole.textContent = roleDisplay;
          
          // Update DOB
          const dob = document.getElementById('infoDOB');
          const editDOB = document.getElementById('editDOB');
          const dobVal = savedProfile.dob || 'Not set';
          if (dob) dob.textContent = dobVal;
          if (editDOB && dobVal !== 'Not set') {
            // Convert "Month DD, YYYY" to "YYYY-MM-DD" for date input
            const dateObj = new Date(dobVal);
            if (!isNaN(dateObj.getTime())) {
              editDOB.value = dateObj.toISOString().split('T')[0];
            }
          }
          
          // Update gender
          const gender = document.getElementById('infoGender');
          const editGender = document.getElementById('editGender');
          const genderVal = savedProfile.gender || 'Not set';
          if (gender) gender.textContent = genderVal;
          if (editGender) editGender.value = genderVal !== 'Not set' ? genderVal : '';
        }
        
        // Update edit form name
        const editName = document.getElementById('editName');
        if (editName) {
          editName.value = savedProfile.fullName || userData?.name || '';
        }
      }
    </script>
  </body>
</html>
