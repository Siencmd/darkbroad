rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is signed in
    function signedIn() {
      return request.auth != null;
    }

    // Helper function to check if user has a profile in users collection
    function hasUsersProfile() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Helper function to check if user has a profile in students collection (legacy)
    function hasStudentsProfile() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }

    // Helper function to check if user exists in either collection
    function userExists() {
      return hasUsersProfile() || hasStudentsProfile();
    }

    // Helper function to get user's course from their profile
    function userCourse() {
      return hasUsersProfile()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.course
        : get(/databases/$(database)/documents/students/$(request.auth.uid)).data.course;
    }

    // Helper function to get user's role from their profile
    function userRole() {
      return hasUsersProfile()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user belongs to the course
    function inCourse(courseId) {
      return signedIn() && userExists() && userCourse() == courseId;
    }

    // Helper function to check if user is an instructor for the course
    function isInstructor(courseId) {
      return inCourse(courseId) &&
        (userRole() is string) &&
        userRole().matches('(?i)^\\s*(instructor|teacher|admin)\\s*$');
    }

    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    // Students collection (legacy) - users can read/write their own profile
    match /students/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    // Subjects collection - document ID is the course name (e.g., "BSIT")
    // This is a single document per course containing all subjects
    match /subjects/{courseId} {
      // All signed-in users in the course can read (for realtime updates)
      allow read: if inCourse(courseId);
      
      // Only instructors can write (create, update, delete)
      allow write: if isInstructor(courseId);

      // Tasks subcollection
      match /tasks/{taskId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);

        match /submissions/{studentId} {
          allow read: if inCourse(courseId);
          allow create, update: if inCourse(courseId) && request.auth.uid == studentId;
          allow delete: if isInstructor(courseId);
        }
      }

      // Assignments subcollection
      match /assignments/{assignmentId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);

        match /submissions/{studentId} {
          allow read: if inCourse(courseId);
          allow create, update: if inCourse(courseId) && request.auth.uid == studentId;
          allow delete: if isInstructor(courseId);
        }
      }

      // Lessons subcollection
      match /lessons/{lessonId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);
      }

      // Quizzes subcollection
      match /quizzes/{quizId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);
      }
    }

    // Orders collection
    match /orders/{orderId} {
      allow read: if signedIn() && resource.data.customerId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.customerId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.customerId == request.auth.uid;
    }
  }
}
