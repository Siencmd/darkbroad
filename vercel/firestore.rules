rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function hasUsersProfile() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasStudentsProfile() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }

    function userExists() {
      return hasUsersProfile() || hasStudentsProfile();
    }

    function userCourse() {
      return hasUsersProfile()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.course
        : get(/databases/$(database)/documents/students/$(request.auth.uid)).data.course;
    }

    function userRole() {
      return hasUsersProfile()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role;
    }

    function inCourse(courseId) {
      return signedIn() && userExists() && userCourse() == courseId;
    }

    function isInstructor(courseId) {
      return inCourse(courseId) &&
        (userRole() == "instructor" ||
         userRole() == "Instructor" ||
         userRole() == "teacher" ||
         userRole() == "Teacher" ||
         userRole() == "admin" ||
         userRole() == "Admin");
    }

    match /users/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    // Backward compatibility for old account profiles.
    match /students/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    match /subjects/{courseId} {
      allow read: if inCourse(courseId);
      allow write: if isInstructor(courseId);

      match /tasks/{taskId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);

        match /submissions/{studentId} {
          allow read: if inCourse(courseId);
          allow create, update: if inCourse(courseId) && request.auth.uid == studentId;
          allow delete: if isInstructor(courseId) || (inCourse(courseId) && request.auth.uid == studentId);
        }
      }

      match /assignments/{assignmentId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);

        match /submissions/{studentId} {
          allow read: if inCourse(courseId);
          allow create, update: if inCourse(courseId) && request.auth.uid == studentId;
          allow delete: if isInstructor(courseId) || (inCourse(courseId) && request.auth.uid == studentId);
        }
      }

      match /lessons/{lessonId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);
      }

      match /quizzes/{quizId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);
      }
    }

    match /orders/{orderId} {
      allow read: if signedIn() && resource.data.customerId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.customerId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.customerId == request.auth.uid;
    }
  }
}
