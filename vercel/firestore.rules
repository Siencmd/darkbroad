rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is signed in
    function signedIn() {
      return request.auth != null;
    }

    // Helper function to check if user has a profile in users collection
    function hasUsersProfile() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Helper function to check if user has a profile in students collection (legacy)
    function hasStudentsProfile() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }

    // Helper function to check if user has a profile in instructors collection
    function hasInstructorsProfile() {
      return exists(/databases/$(database)/documents/instructors/$(request.auth.uid));
    }

    // Helper function to check if user exists in either collection
    function userExists() {
      return hasUsersProfile() || hasInstructorsProfile() || hasStudentsProfile();
    }

    // Helper function to get user's course from their profile
    function userCourse() {
      return hasUsersProfile()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.course
        : (
            hasInstructorsProfile()
              ? get(/databases/$(database)/documents/instructors/$(request.auth.uid)).data.course
              : get(/databases/$(database)/documents/students/$(request.auth.uid)).data.course
          );
    }

    // Helper function to get user's role from their profile
    function userRole() {
      return hasUsersProfile()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : (
            hasInstructorsProfile()
              ? get(/databases/$(database)/documents/instructors/$(request.auth.uid)).data.role
              : get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role
          );
    }

    // Helper function to check if user belongs to the course
    function sameCourse(courseId) {
      return (userCourse() is string) &&
        (courseId is string) &&
        userCourse().matches('(?i)^\\s*' + courseId + '\\s*$');
    }

    // Helper function to check if user belongs to the course
    function inCourse(courseId) {
      return signedIn() && userExists() && sameCourse(courseId);
    }

    // Helper function to check if user is an instructor for the course
    function isInstructor(courseId) {
      return inCourse(courseId) &&
        (userRole() is string) &&
        userRole().matches('(?i)^\\s*(instructor|teacher|admin)\\s*$');
    }

    // Helper function to check if user is an instructor (general - not course-specific)
    function isInstructorRole() {
      return signedIn() && userExists() &&
        (userRole() is string) &&
        userRole().matches('(?i)^\\s*(instructor|teacher|admin)\\s*$');
    }

    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    // Students collection (legacy) - users can read/write their own profile
    match /students/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    // Instructors collection - users can read/write their own profile
    match /instructors/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    // Subjects collection - document ID is the course name (e.g., "BSIT")
    match /subjects/{courseId} {
      allow read: if inCourse(courseId);
      allow write: if isInstructor(courseId);

      // Tasks subcollection
      match /tasks/{taskId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);

        match /submissions/{studentId} {
          allow read: if inCourse(courseId);
          allow create: if inCourse(courseId) && request.auth.uid == studentId;
          allow update: if (inCourse(courseId) && request.auth.uid == studentId) || isInstructor(courseId);
          allow delete: if isInstructor(courseId);
        }
      }

      // Assignments subcollection
      match /assignments/{assignmentId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);

        match /submissions/{studentId} {
          allow read: if inCourse(courseId);
          allow create: if inCourse(courseId) && request.auth.uid == studentId;
          allow update: if (inCourse(courseId) && request.auth.uid == studentId) || isInstructor(courseId);
          allow delete: if isInstructor(courseId);
        }
      }

      // Lessons subcollection
      match /lessons/{lessonId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);
      }

      // Quizzes subcollection
      match /quizzes/{quizId} {
        allow read: if inCourse(courseId);
        allow write: if isInstructor(courseId);

        match /submissions/{studentId} {
          allow read: if inCourse(courseId);
          allow create: if inCourse(courseId) && request.auth.uid == studentId;
          allow update: if (inCourse(courseId) && request.auth.uid == studentId) || isInstructor(courseId);
          allow delete: if isInstructor(courseId);
        }
      }
    }

    // Announcements collection - all signed-in users can read, only instructors can create/update/delete
    match /announcements/{announcementId} {
      allow read: if signedIn() && userExists();
      allow create: if isInstructorRole();
      allow update, delete: if isInstructorRole() && resource.data.authorId == request.auth.uid;
    }

    // Orders collection
    match /orders/{orderId} {
      allow read: if signedIn() && resource.data.customerId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.customerId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.customerId == request.auth.uid;
    }
  }
}
