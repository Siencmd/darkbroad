<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0a1929" />
    <title>Students - Darkboard</title>
    <meta name="description" content="View and manage students in your courses" />
    <meta name="author" content="Darkboard Team" />
    <link rel="stylesheet" href="Darkboard.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Main Navigation -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <div class="nav-header">
        <a href="#" class="brand" id="dashboardLink">DARKBOARD</a>
      </div>
      <ul class="nav-list">
        <li><a href="#" class="nav-item" id="navDashboard"><i class="fas fa-th-large"></i><span>Dashboard</span></a></li>
        <li><a href="Subjects.html" class="nav-item"><i class="fas fa-book"></i><span>Subjects</span></a></li>
        <li><a href="Grades.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Grades</span></a></li>
        <li><a href="Schedule.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a></li>
        <li><a href="Announcements.html" class="nav-item"><i class="fas fa-bell"></i><span>Announcements</span></a></li>
        <li><a href="Submissions.html" class="nav-item"><i class="fas fa-file-upload"></i><span>Submissions</span></a></li>
        <li><a href="Students.html" class="nav-item active"><i class="fas fa-users"></i><span>Students</span></a></li>
        <li><a href="Profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a></li>
        <li><a href="Settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        <li><a href="Help.html" class="nav-item"><i class="fas fa-question-circle"></i><span>Help</span></a></li>
        <li><a href="#" id="logoutBtn" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
      </ul>
      <div class="nav-right">
        <div class="user-menu-right">
          <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="User avatar" class="user-avatar">
          <span id="headerUserName">Loading...</span>
        </div>
      </div>
      <div class="top-user-name" id="topUserName"></div>
    </nav>

    <!-- Main Content -->
    <main class="content">
      <div class="welcome-section">
        <div class="welcome-text">
          <h1><i class="fas fa-users"></i> Students</h1>
          <p id="pageDescription">View and manage students in your courses.</p>
        </div>
      </div>

      <!-- Filter Section -->
      <section class="card" aria-labelledby="filter-heading">
        <div class="card-header">
          <h2 id="filter-heading"><i class="fas fa-filter"></i> Filter Students</h2>
        </div>
        <div class="filter-controls">
          <div class="filter-group">
            <label for="subjectFilter">Subject:</label>
            <select id="subjectFilter" class="filter-select">
              <option value="">All Subjects</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="searchStudent">Search:</label>
            <input type="text" id="searchStudent" class="filter-input" placeholder="Search by name or email...">
          </div>
          <button class="btn btn-primary" id="applyFilterBtn">
            <i class="fas fa-search"></i> Apply
          </button>
        </div>
      </section>

      <!-- Students List -->
      <section class="card" aria-labelledby="students-heading">
        <div class="card-header">
          <h2 id="students-heading"><i class="fas fa-user-graduate"></i> Student List</h2>
          <span class="student-count" id="studentCount">Loading...</span>
        </div>
        <div class="students-grid" id="studentsList">
          <div class="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading students from database...</p>
          </div>
        </div>
      </section>
    </main>

    <!-- View Student Profile Modal -->
    <div id="viewProfileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user"></i> Student Profile</h2>
          <span class="close-modal" onclick="closeModal('viewProfileModal')">&times;</span>
        </div>
        <div class="modal-body" id="viewProfileContent">
          <!-- Content loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- Message Student Modal -->
    <div id="messageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-envelope"></i> Send Message</h2>
          <span class="close-modal" onclick="closeModal('messageModal')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="messageForm">
            <input type="hidden" id="messageStudentId">
            <div class="form-group">
              <label>To:</label>
              <p id="messageToName" class="form-value"></p>
            </div>
            <div class="form-group">
              <label for="messageSubject">Subject *</label>
              <input type="text" id="messageSubject" required placeholder="Enter message subject">
            </div>
            <div class="form-group">
              <label for="messageContent">Message *</label>
              <textarea id="messageContent" rows="5" required placeholder="Enter your message"></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal('messageModal')">Cancel</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Send
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content modal-sm">
        <div class="modal-header">
          <h2><i class="fas fa-exclamation-triangle"></i> Delete Student</h2>
          <span class="close-modal" onclick="closeModal('deleteModal')">&times;</span>
        </div>
        <div class="modal-body">
          <p id="deleteMessage">Are you sure you want to delete this student account?</p>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="firebase.js"></script>
    <script type="module" src="script.js"></script>
    <script src="https://unpkg.com/scrollreveal"></script>
    <script type="module">
      import { logout } from "./script.js";
      import { auth, db } from "./firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { doc, getDoc, getDocs, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      
      // Role check
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      const normalizedRole = (userData.role || '').toLowerCase();
      const isInstructor = normalizedRole === 'instructor' || normalizedRole === 'teacher' || normalizedRole === 'admin';
      
      // Set up dashboard link based on role
      const dashboardLink = document.getElementById('dashboardLink');
      const navDashboard = document.getElementById('navDashboard');
      if (isInstructor) {
        dashboardLink.href = 'InstructorDashboard.html';
        navDashboard.href = 'InstructorDashboard.html';
      } else {
        dashboardLink.href = 'index.html';
        navDashboard.href = 'index.html';
      }

      // Logout button
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) logoutBtn.addEventListener("click", (e) => logout(e));

      // Update page description based on role
      const pageDescription = document.getElementById('pageDescription');
      if (!isInstructor && pageDescription) {
        pageDescription.textContent = 'View your classmates and course peers.';
      }

      // Load subjects for filter
      const subjects = JSON.parse(localStorage.getItem('subjects') || '[]');
      const subjectFilter = document.getElementById('subjectFilter');
      
      if (subjectFilter) {
        subjects.forEach(subject => {
          const option = document.createElement('option');
          option.value = subject.name;
          option.textContent = subject.name;
          subjectFilter.appendChild(option);
        });
      }

      // Load real students from Firestore
      let allStudents = [];

      async function loadStudentsFromFirestore() {
        const studentsList = document.getElementById('studentsList');
        const studentCount = document.getElementById('studentCount');
        
        if (!studentsList) return;
        
        try {
          // Get current user to exclude them
          const currentUid = auth.currentUser?.uid || userData.id;
          
          // Query students collection - get only students (not instructors)
          const studentsRef = collection(db, 'students');
          const q = query(studentsRef, where('role', '==', 'student'));
          
          const snapshot = await getDocs(q);
          allStudents = [];
          
          snapshot.forEach(doc => {
            const data = doc.data();
            // Exclude instructors and current user
            const role = (data.role || '').toLowerCase();
            if (role !== 'instructor' && role !== 'teacher' && role !== 'admin' && doc.id !== currentUid) {
              allStudents.push({
                id: doc.id,
                name: data.fullName || data.name || 'Unknown',
                email: data.email || '',
                course: data.course || 'Not assigned',
                subjects: data.subjects || [],
                profileVisibility: data.profileVisibility || 'Everyone',
                showOnlineStatus: data.showOnlineStatus !== false,
                isOnline: Math.random() > 0.7 // Simulated - would need realtime tracking
              });
            }
          });
          
          // If no students in Firestore, try users collection
          if (allStudents.length === 0) {
            const usersRef = collection(db, 'users');
            const usersSnapshot = await getDocs(usersRef);
            
            usersSnapshot.forEach(doc => {
              const data = doc.data();
              const role = (data.role || '').toLowerCase();
              // Only include students, exclude instructors and current user
              if (role === 'student' && doc.id !== currentUid) {
                allStudents.push({
                  id: doc.id,
                  name: data.fullName || data.name || 'Unknown',
                  email: data.email || '',
                  course: data.course || 'Not assigned',
                  subjects: data.subjects || [],
                  profileVisibility: data.profileVisibility || 'Everyone',
                  showOnlineStatus: data.showOnlineStatus !== false,
                  isOnline: Math.random() > 0.7
                });
              }
            });
          }
          
          renderStudents(allStudents);
          
        } catch (error) {
          console.log('Error loading students:', error.message);
          // Fallback: show empty state
          studentsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-user-slash"></i>
              <p>No students found in database</p>
              <p class="empty-subtitle">Students will appear here once they register</p>
            </div>
          `;
          if (studentCount) studentCount.textContent = '0 students';
        }
      }

      // Render students
      function renderStudents(students) {
        const studentsList = document.getElementById('studentsList');
        const studentCount = document.getElementById('studentCount');
        
        if (!studentsList) return;
        
        // Filter by subject and search
        const subjectValue = subjectFilter?.value || '';
        const searchValue = document.getElementById('searchStudent')?.value?.toLowerCase() || '';
        
        let filteredStudents = students;
        
        if (subjectValue) {
          filteredStudents = filteredStudents.filter(s => 
            s.subjects && s.subjects.some(sub => sub.toLowerCase().includes(subjectValue.toLowerCase()))
          );
        }
        
        if (searchValue) {
          filteredStudents = filteredStudents.filter(s => 
            s.name.toLowerCase().includes(searchValue) || 
            s.email.toLowerCase().includes(searchValue)
          );
        }
        
        // Update count
        if (studentCount) {
          studentCount.textContent = `${filteredStudents.length} student${filteredStudents.length !== 1 ? 's' : ''}`;
        }
        
        // Render students
        if (filteredStudents.length === 0) {
          studentsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-user-slash"></i>
              <p>No students found</p>
            </div>
          `;
          return;
        }
        
        studentsList.innerHTML = filteredStudents.map(student => {
          // Check visibility permissions
          let canViewProfile = true;
          let showOnlineStatus = false;
          
          if (student.profileVisibility === 'Private') {
            canViewProfile = false;
          } else if (student.profileVisibility === 'Classmates Only' && !isInstructor) {
            canViewProfile = true;
          }
          
          if (student.isOnline && student.showOnlineStatus && student.profileVisibility !== 'Private') {
            showOnlineStatus = true;
          }
          
          const visibilityIcon = student.profileVisibility === 'Private' ? 'fa-lock' : 
                                student.profileVisibility === 'Classmates Only' ? 'fa-user-friends' : 'fa-globe';
          const visibilityClass = student.profileVisibility === 'Private' ? 'visibility-private' : 
                                 student.profileVisibility === 'Classmates Only' ? 'visibility-classmates' : 'visibility-everyone';
          
          return `
            <div class="student-card">
              <div class="student-avatar">
                <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="${student.name}">
                ${showOnlineStatus ? '<span class="online-indicator"></span>' : ''}
              </div>
              <div class="student-info">
                <h3>${student.name}</h3>
                ${canViewProfile ? `
                <p class="student-email"><i class="fas fa-envelope"></i> ${student.email}</p>
                <p class="student-subjects"><i class="fas fa-book"></i> ${student.subjects?.length ? student.subjects.join(', ') : 'No subjects'}</p>
                <p class="student-course"><i class="fas fa-graduation-cap"></i> ${student.course}</p>
                ` : `
                <p class="student-email"><i class="fas fa-lock"></i> Profile Hidden</p>
                `}
                <p class="student-visibility ${visibilityClass}"><i class="fas ${visibilityIcon}"></i> ${student.profileVisibility}</p>
              </div>
              <div class="student-actions">
                <button class="btn-icon" title="View Profile" onclick="viewStudentProfile('${student.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                ${isInstructor ? `
                <button class="btn-icon" title="Send Message" onclick="openMessageModal('${student.id}', '${student.name}')">
                  <i class="fas fa-envelope"></i>
                </button>
                <button class="btn-icon btn-danger" title="Delete Student" onclick="confirmDeleteStudent('${student.id}', '${student.name}')">
                  <i class="fas fa-trash"></i>
                </button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      // Filter handlers
      const applyFilterBtn = document.getElementById('applyFilterBtn');
      if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', () => renderStudents(allStudents));
      }
      
      const searchStudent = document.getElementById('searchStudent');
      if (searchStudent) {
        searchStudent.addEventListener('keyup', (e) => {
          if (e.key === 'Enter') {
            renderStudents(allStudents);
          }
        });
      }

      // Modal functions
      window.closeModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
      };

      // View student profile
      window.viewStudentProfile = function(studentId) {
        const student = allStudents.find(s => s.id === studentId);
        if (!student) return;
        
        const content = document.getElementById('viewProfileContent');
        if (content) {
          content.innerHTML = `
            <div class="profile-view">
              <div class="profile-avatar-large">
                <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="${student.name}">
              </div>
              <h3>${student.name}</h3>
              <p class="profile-email">${student.email}</p>
              <div class="profile-details">
                <p><i class="fas fa-graduation-cap"></i> <strong>Course:</strong> ${student.course}</p>
                <p><i class="fas fa-eye"></i> <strong>Visibility:</strong> ${student.profileVisibility}</p>
                <p><i class="fas fa-circle"></i> <strong>Status:</strong> ${student.isOnline ? 'Online' : 'Offline'}</p>
              </div>
            </div>
          `;
        }
        document.getElementById('viewProfileModal').style.display = 'block';
      };

      // Message student modal
      window.openMessageModal = function(studentId, studentName) {
        document.getElementById('messageStudentId').value = studentId;
        document.getElementById('messageToName').textContent = studentName;
        document.getElementById('messageModal').style.display = 'block';
      };

      // Handle message form
      const messageForm = document.getElementById('messageForm');
      if (messageForm) {
        messageForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const studentId = document.getElementById('messageStudentId').value;
          const subject = document.getElementById('messageSubject').value;
          const content = document.getElementById('messageContent').value;
          
          // Save message to Firestore
          try {
            await addDoc(collection(db, 'messages'), {
              fromId: auth.currentUser?.uid || userData.id,
              fromName: userData.name || 'Instructor',
              toId: studentId,
              subject: subject,
              content: content,
              createdAt: serverTimestamp(),
              read: false
            });
            
            alert('Message sent successfully!');
            closeModal('messageModal');
            messageForm.reset();
          } catch (error) {
            alert('Failed to send message: ' + error.message);
          }
        });
      }

      // Delete student
      let studentToDelete = null;
      
      window.confirmDeleteStudent = function(studentId, studentName) {
        studentToDelete = { id: studentId, name: studentName };
        document.getElementById('deleteMessage').textContent = 
          `Are you sure you want to delete the account for ${studentName}? This action cannot be undone.`;
        document.getElementById('deleteModal').style.display = 'block';
      };

      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async () => {
          if (!studentToDelete) return;
          
          try {
            // Delete from Firestore
            try {
              await deleteDoc(doc(db, 'students', studentToDelete.id));
            } catch (e) {}
            
            try {
              await deleteDoc(doc(db, 'users', studentToDelete.id));
            } catch (e) {}
            
            // Remove from local array
            allStudents = allStudents.filter(s => s.id !== studentToDelete.id);
            
            alert(`${studentToDelete.name}'s account has been deleted.`);
            closeModal('deleteModal');
            renderStudents(allStudents);
            
          } catch (error) {
            alert('Failed to delete student: ' + error.message);
          }
          
          studentToDelete = null;
        });
      }

      // Close modals on outside click
      window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      };

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        loadStudentsFromFirestore();
        
        // Update header username
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName && userData) {
          headerUserName.textContent = userData.name || 'User';
        }
      });

      // ScrollReveal animations
      ScrollReveal().reveal(".student-card", {
        delay: 200,
        interval: 100,
        distance: '20px'
      });
    </script>
  </body>
</html>
