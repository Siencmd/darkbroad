<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submissions - Darkboard</title>
    <link rel="stylesheet" href="Darkboard.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <link rel="icon" type="image/png" href="Gemini_Generated_Image_g3iakg3iakg3iakg.png" />
  </head>
  <body>
    <!-- Main Navigation - Horizontal for All -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <div class="nav-header">
        <a href="index.html" class="brand">DARKBOARD</a>
      </div>
      <ul class="nav-list">
        <li><a href="index.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a></li>
        <li><a href="Subjects.html" class="nav-item"><i class="fas fa-book"></i><span>Subjects</span></a></li>
        <li><a href="Grades.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Grades</span></a></li>
        <li><a href="Schedule.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a></li>
        <li><a href="Announcements.html" class="nav-item"><i class="fas fa-bell"></i><span>Announcements</span></a></li>
        <li><a href="Submissions.html" class="nav-item active"><i class="fas fa-file-upload"></i><span>Submissions</span></a></li>
        <li><a href="Profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a></li>
        <li><a href="Settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        <li><a href="Help.html" class="nav-item"><i class="fas fa-question-circle"></i><span>Help</span></a></li>
        <li><a href="#" id="logoutBtn" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
      </ul>
      <div class="nav-right">
        <div class="user-menu-right">
          <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="User avatar" class="user-avatar">
          <span id="headerUserName">Loading...</span>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="content">
      <div class="welcome-section">
        <div class="welcome-text">
          <h1><i class="fas fa-file-upload"></i> Submissions & Grading</h1>
          <p id="submissionsSubtitle">View and grade student submissions</p>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-filter"></i> Filter Submissions</h2>
        </div>
        <div class="submissions-filters">
          <div class="filter-group">
            <label for="subjectFilter">Subject:</label>
            <select id="subjectFilter" class="filter-select">
              <option value="all">All Subjects</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter" class="filter-select">
              <option value="all">All Status</option>
              <option value="pending">Pending Grading</option>
              <option value="graded">Graded</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="typeFilter">Type:</label>
            <select id="typeFilter" class="filter-select">
              <option value="all">All Types</option>
              <option value="assignment">Assignments</option>
              <option value="task">Tasks</option>
              <option value="quiz">Quizzes</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Submissions List -->
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-list"></i> All Submissions</h2>
          <div class="submissions-stats">
            <span class="stat-badge pending">
              <i class="fas fa-clock"></i> <span id="pendingCount">0</span> Pending
            </span>
            <span class="stat-badge graded">
              <i class="fas fa-check-circle"></i> <span id="gradedCount">0</span> Graded
            </span>
          </div>
        </div>
        
        <div id="submissionsContainer" class="submissions-container">
          <!-- Submissions will be loaded here dynamically -->
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>No submissions found</p>
          </div>
        </div>
      </div>

      <!-- Grading Modal -->
      <div class="modal" id="gradingModal" style="display: none;">
        <div class="modal-content large-modal">
          <span class="close" id="closeGradingModal">&times;</span>
          <div class="modal-body">
            <h2 id="modalTitle">Grade Submission</h2>
            <div id="modalContent">
              <!-- Content will be loaded dynamically -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module" src="firebase.js"></script>
    <script type="module" src="script.js"></script>
    <script type="module">
      import { logout } from "./script.js";
      import { auth, db } from './firebase.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { doc, getDoc, getDocs, collection, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      const logoutBtn = document.getElementById("logoutBtn");
      logoutBtn.addEventListener("click", (e) => logout(e));
      
      // Load user data for header
      window.addEventListener('DOMContentLoaded', () => {
        const userData = JSON.parse(localStorage.getItem('userData'));
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName && userData) {
          headerUserName.textContent = userData.name || 'User';
        }
      });

      // Initialize submissions page
      let subjects = [];
      let allSubmissions = [];
      let userData = null;
      let isInstructor = false;
      const pageParams = new URLSearchParams(window.location.search);
      const focusSubject = pageParams.get('subject');
      const focusType = pageParams.get('type');
      const focusItemId = pageParams.get('itemId');

      // Load user data and subjects
      async function initializeSubmissionsPage() {
        userData = JSON.parse(localStorage.getItem("userData") || "{}");
        const userRole = (userData?.role || 'student').toLowerCase();
        isInstructor = userRole === 'instructor' || userRole === 'teacher' || userRole === 'admin';

        // Update subtitle based on role
        const subtitle = document.getElementById('submissionsSubtitle');
        if (isInstructor) {
          subtitle.textContent = 'View and grade student submissions';
        } else {
          subtitle.textContent = 'View your submissions and grades';
        }

        // Load subjects from localStorage
        subjects = JSON.parse(localStorage.getItem('subjects') || '[]');
        
        // Populate subject filter
        const subjectFilter = document.getElementById('subjectFilter');
        subjects.forEach((subject, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = subject.name;
          subjectFilter.appendChild(option);
        });

        if (focusSubject !== null && focusSubject !== '') {
          subjectFilter.value = String(focusSubject);
        }
        if (focusType) {
          const typeFilterEl = document.getElementById('typeFilter');
          if (typeFilterEl) typeFilterEl.value = String(focusType).toLowerCase();
        }

        // Load all submissions
        await loadAllSubmissions();
        
        // Setup filter listeners
        document.getElementById('subjectFilter').addEventListener('change', filterSubmissions);
        document.getElementById('statusFilter').addEventListener('change', filterSubmissions);
        document.getElementById('typeFilter').addEventListener('change', filterSubmissions);

        // Apply deep-link filters from Subjects page if present
        if ((focusSubject !== null && focusSubject !== '') || focusType || focusItemId) {
          filterSubmissions();
        }
      }

      // Load all submissions from all subjects
      async function loadAllSubmissions() {
        allSubmissions = [];
        const container = document.getElementById('submissionsContainer');
        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading submissions...</div>';

        try {
          for (let subjectIndex = 0; subjectIndex < subjects.length; subjectIndex++) {
            const subject = subjects[subjectIndex];
            
            // Load assignments
            if (subject.assignments && subject.assignments.length > 0) {
              for (const assignment of subject.assignments) {
                if (assignment.id) {
                  const submissions = await fetchSubmissions('assignment', assignment.id, userData.course);
                  submissions.forEach(sub => {
                    allSubmissions.push({
                      ...sub,
                      subjectIndex,
                      subjectName: subject.name,
                      itemType: 'assignment',
                      itemTitle: assignment.title,
                      itemPoints: assignment.points,
                      itemDueDate: assignment.dueDate,
                      itemId: assignment.id
                    });
                  });
                }
              }
            }

            // Load tasks
            if (subject.tasks && subject.tasks.length > 0) {
              for (const task of subject.tasks) {
                if (task.id) {
                  const submissions = await fetchSubmissions('task', task.id, userData.course);
                  submissions.forEach(sub => {
                    allSubmissions.push({
                      ...sub,
                      subjectIndex,
                      subjectName: subject.name,
                      itemType: 'task',
                      itemTitle: task.title,
                      itemPoints: 100, // Default points for tasks
                      itemDueDate: task.dueDate,
                      itemId: task.id
                    });
                  });
                }
              }
            }

            // Load quizzes
            if (subject.quizzes && subject.quizzes.length > 0) {
              for (const quiz of subject.quizzes) {
                if (quiz.id) {
                  const submissions = await fetchSubmissions('quiz', quiz.id, userData.course);
                  submissions.forEach(sub => {
                    allSubmissions.push({
                      ...sub,
                      subjectIndex,
                      subjectName: subject.name,
                      itemType: 'quiz',
                      itemTitle: quiz.title,
                      itemPoints: quiz.points,
                      itemDueDate: quiz.dueDate,
                      itemId: quiz.id
                    });
                  });
                }
              }
            }
          }

          // Filter submissions for students (only show their own)
          if (!isInstructor) {
            allSubmissions = allSubmissions.filter(sub => sub.studentId === userData.id);
          }

          renderSubmissions(allSubmissions);
          updateStats();
        } catch (error) {
          console.error('Error loading submissions:', error);
          container.innerHTML = '<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading submissions</p></div>';
        }
      }

      // Fetch submissions from Firestore
      async function fetchSubmissions(type, itemId, courseId) {
        if (!courseId || !itemId) return [];
        
        const collectionName = type === 'task' ? 'tasks' : type === 'assignment' ? 'assignments' : 'quizzes';
        const submissionsRef = collection(db, "subjects", courseId, collectionName, itemId, "submissions");
        
        try {
          const submissionsSnap = await getDocs(submissionsRef);
          const submissions = [];
          submissionsSnap.forEach((doc) => {
            const submissionData = doc.data() || {};
            submissions.push({
              id: doc.id,
              ...submissionData,
              studentId: submissionData.studentId || doc.id
            });
          });
          return submissions;
        } catch (error) {
          console.warn(`Could not fetch ${type} submissions:`, error.message);
          return [];
        }
      }

      // Render submissions
      function renderSubmissions(submissions) {
        const container = document.getElementById('submissionsContainer');
        
        if (submissions.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No submissions found</p></div>';
          return;
        }

        container.innerHTML = submissions.map(sub => `
          <div class="submission-card ${sub.status === 'graded' ? 'graded' : 'pending'}">
            <div class="submission-card-header">
              <div class="submission-info">
                <h3>${sub.itemTitle}</h3>
                <p class="submission-meta">
                  <span class="subject-badge">${sub.subjectName}</span>
                  <span class="type-badge ${sub.itemType}">${sub.itemType}</span>
                </p>
              </div>
              <div class="submission-status">
                ${sub.status === 'graded' ? 
                  `<span class="status-badge graded"><i class="fas fa-check-circle"></i> Graded</span>` :
                  `<span class="status-badge pending"><i class="fas fa-clock"></i> Pending</span>`
                }
              </div>
            </div>
            
            <div class="submission-card-body">
              ${isInstructor ? `
                <p><strong>Student:</strong> ${sub.studentName || 'Unknown'}</p>
              ` : ''}
              <p><strong>Submitted:</strong> ${formatDate(sub.submittedAt)}</p>
              <p><strong>File:</strong> <a href="${sub.fileUrl}" target="_blank">${sub.fileName}</a></p>
              
              ${sub.grade !== undefined ? `
                <div class="grade-display">
                  <strong>Grade:</strong> <span class="grade-value">${sub.grade} / ${sub.itemPoints}</span>
                  ${sub.feedback ? `<p class="feedback-text"><strong>Feedback:</strong> ${sub.feedback}</p>` : ''}
                </div>
              ` : ''}
            </div>
            
            <div class="submission-card-footer">
              ${isInstructor && sub.status !== 'graded' ? `
                <button class="btn-grade" onclick="openGradingModal('${sub.subjectIndex}', '${sub.itemType}', '${sub.itemId}', '${sub.studentId}', ${sub.itemPoints})">
                  <i class="fas fa-edit"></i> Grade Submission
                </button>
              ` : ''}
              ${isInstructor && sub.status === 'graded' ? `
                <button class="btn-edit-grade" onclick="openGradingModal('${sub.subjectIndex}', '${sub.itemType}', '${sub.itemId}', '${sub.studentId}', ${sub.itemPoints})">
                  <i class="fas fa-edit"></i> Edit Grade
                </button>
              ` : ''}
            </div>
          </div>
        `).join('');
      }

      // Filter submissions
      function filterSubmissions() {
        const subjectFilter = document.getElementById('subjectFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;

        let filtered = allSubmissions;

        if (subjectFilter !== 'all') {
          filtered = filtered.filter(sub => sub.subjectIndex == subjectFilter);
        }

        if (statusFilter !== 'all') {
          filtered = filtered.filter(sub => sub.status === statusFilter);
        }

        if (typeFilter !== 'all') {
          filtered = filtered.filter(sub => sub.itemType === typeFilter);
        }

        if (focusItemId) {
          filtered = filtered.filter(sub => String(sub.itemId) === String(focusItemId));
        }

        renderSubmissions(filtered);
      }

      // Update statistics
      function updateStats() {
        const pending = allSubmissions.filter(sub => sub.status !== 'graded').length;
        const graded = allSubmissions.filter(sub => sub.status === 'graded').length;
        
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('gradedCount').textContent = graded;
      }

      // Format date
      function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString();
      }

      // Open grading modal
      window.openGradingModal = async function(subjectIndex, itemType, itemId, studentId, itemPoints) {
        const modal = document.getElementById('gradingModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');

        // Find the submission
        const submission = allSubmissions.find(sub =>
          sub.subjectIndex == subjectIndex &&
          sub.itemType === itemType &&
          sub.itemId === itemId &&
          sub.studentId === studentId
        );

        if (!submission) {
          alert('Submission not found');
          return;
        }

        modalTitle.textContent = `Grade: ${submission.itemTitle}`;

        // Use itemPoints from function parameter or fallback to submission's itemPoints or default to 100
        const maxPoints = itemPoints || submission.itemPoints || 100;

        modalContent.innerHTML = `
          <div class="grading-form">
            <div class="submission-details">
              <p><strong>Student:</strong> ${submission.studentName}</p>
              <p><strong>Submitted:</strong> ${formatDate(submission.submittedAt)}</p>
              <p><strong>File:</strong> <a href="${submission.fileUrl}" target="_blank">${submission.fileName}</a></p>
            </div>

            <div class="grade-input-section">
              <div class="form-group">
                <label for="gradeInput">Grade:</label>
                <input
                  type="number"
                  id="gradeInput"
                  class="grade-input"
                  value="${submission.grade !== undefined ? submission.grade : ''}"
                  min="0"
                  max="${maxPoints}"
                  placeholder="0"
                /> / ${maxPoints} points
              </div>

              <div class="form-group">
                <label for="feedbackInput">Feedback:</label>
                <textarea 
                  id="feedbackInput" 
                  class="feedback-input" 
                  rows="5"
                  placeholder="Enter feedback for student..."
                >${submission.feedback || ''}</textarea>
              </div>

              <button class="btn-save-grade" onclick="saveGradeFromModal('${subjectIndex}', '${itemType}', '${itemId}', '${studentId}', ${itemPoints})">
                <i class="fas fa-save"></i> Save Grade
              </button>
            </div>
          </div>
        `;

        modal.style.display = 'block';
      };

      // Save grade from modal
      window.saveGradeFromModal = async function(subjectIndex, itemType, itemId, studentId, itemPoints) {
        const gradeInput = document.getElementById('gradeInput');
        const feedbackInput = document.getElementById('feedbackInput');

        const grade = parseFloat(gradeInput.value);
        const feedback = feedbackInput.value.trim();

        // Use fallback value if itemPoints is undefined
        const maxPoints = itemPoints || 100;

        if (isNaN(grade) || grade < 0 || grade > maxPoints) {
          alert(`Grade must be between 0 and ${maxPoints}`);
          return;
        }

        try {
          const collectionName = itemType === 'task' ? 'tasks' : itemType === 'assignment' ? 'assignments' : 'quizzes';
          const submissionRef = doc(db, "subjects", userData.course, collectionName, itemId, "submissions", studentId);
          
          await setDoc(submissionRef, {
            grade: grade,
            maxPoints: maxPoints,
            feedback: feedback,
            gradedAt: serverTimestamp(),
            gradedBy: auth.currentUser.uid,
            status: "graded"
          }, { merge: true });

          // Create notification
          try {
            const notificationRef = doc(collection(db, "notifications", studentId, "items"));
            await setDoc(notificationRef, {
              type: "grade_received",
              title: `Grade Posted`,
              message: `You received ${grade}/${maxPoints} points`,
              read: false,
              timestamp: serverTimestamp()
            });
          } catch (notifError) {
            console.warn("Could not create notification:", notifError.message);
          }

          alert('Grade saved successfully!');
          document.getElementById('gradingModal').style.display = 'none';
          
          // Reload submissions
          await loadAllSubmissions();
        } catch (error) {
          console.error("Error saving grade:", error);
          alert("Failed to save grade: " + error.message);
        }
      };

      // Close modal
      document.getElementById('closeGradingModal').addEventListener('click', () => {
        document.getElementById('gradingModal').style.display = 'none';
      });

      // Initialize on load
      onAuthStateChanged(auth, (user) => {
        if (user) {
          initializeSubmissionsPage();
        } else {
          window.location.href = 'Login.html';
        }
      });
    </script>
  </body>
</html>
