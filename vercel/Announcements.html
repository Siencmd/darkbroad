<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0a1929" />
    <title>Announcements - Darkboard</title>
    <link rel="stylesheet" href="Darkboard.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Main Navigation - Horizontal for All -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <div class="nav-header">
        <a href="index.html" class="brand">DARKBOARD</a>
      </div>
      <ul class="nav-list">
        <li><a href="index.html" class="nav-item"><i class="fas fa-th-large"></i><span>Dashboard</span></a></li>
        <li><a href="Subjects.html" class="nav-item"><i class="fas fa-book"></i><span>Subjects</span></a></li>
        <li><a href="Grades.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Grades</span></a></li>
        <li><a href="Schedule.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a></li>
        <li><a href="Announcements.html" class="nav-item active"><i class="fas fa-bell"></i><span>Announcements</span></a></li>
        <li><a href="Submissions.html" class="nav-item"><i class="fas fa-file-upload"></i><span>Submissions</span></a></li>
        <li><a href="Profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a></li>
        <li><a href="Settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        <li><a href="Help.html" class="nav-item"><i class="fas fa-question-circle"></i><span>Help</span></a></li>
        <li><a href="#" id="logoutBtn" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
      </ul>
      <div class="nav-right">
        <div class="user-menu-right">
          <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="User avatar" class="user-avatar">
          <span id="headerUserName">Loading...</span>
        </div>
      </div>
      <div class="top-user-name" id="topUserName"></div>
    </nav>

    <!-- Main Content -->
    <main class="content">
      <div class="welcome-section">
        <div class="welcome-text">
          <h1>Announcements</h1>
          <p>Stay updated with the latest news and announcements.</p>
        </div>
        <div id="instructorActions" class="instructor-actions" style="display: none;">
          <button class="btn-primary" id="addAnnouncementBtn">
            <i class="fas fa-plus"></i> New Announcement
          </button>
        </div>
      </div>

      <!-- Announcements List -->
      <div class="announcements-list" id="announcementsList">
        <!-- Announcements will be loaded dynamically -->
        <div class="loading-announcements">
          <i class="fas fa-spinner fa-spin"></i> Loading announcements...
        </div>
      </div>

      <!-- Empty State -->
      <div class="card empty-state" id="emptyState" style="display: none;">
        <i class="fas fa-bell-slash"></i>
        <h3>No Announcements Yet</h3>
        <p>There are no announcements to display.</p>
      </div>
    </main>

    <!-- Create/Edit Announcement Modal -->
    <div id="announcementModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeAnnouncementModal">&times;</span>
        <div class="modal-body">
          <h2 id="announcementModalTitle"><i class="fas fa-bullhorn"></i> New Announcement</h2>
          <form id="announcementForm">
            <input type="hidden" id="announcementId" value="">
            <div class="form-group">
              <label for="announcementTitle">Title <span class="required">*</span></label>
              <input type="text" id="announcementTitle" class="form-input" placeholder="Enter announcement title" required>
            </div>
            <div class="form-group">
              <label for="announcementMessage">Message <span class="required">*</span></label>
              <textarea id="announcementMessage" class="form-input" rows="5" placeholder="Enter your announcement message" required></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="announcementCategory">Category</label>
                <select id="announcementCategory" class="form-input">
                  <option value="General">General</option>
                  <option value="Academic">Academic</option>
                  <option value="Events">Events</option>
                  <option value="Resources">Resources</option>
                  <option value="Club">Club</option>
                  <option value="Urgent">Urgent</option>
                </select>
              </div>
              <div class="form-group">
                <label for="announcementIcon">Icon</label>
                <select id="announcementIcon" class="form-input">
                  <option value="bell">Bell</option>
                  <option value="graduation-cap">Graduation Cap</option>
                  <option value="calendar-check">Calendar</option>
                  <option value="book">Book</option>
                  <option value="users">Users</option>
                  <option value="exclamation-triangle">Warning</option>
                  <option value="info-circle">Info</option>
                  <option value="star">Star</option>
                </select>
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel" id="cancelAnnouncement">Cancel</button>
              <button type="submit" class="btn-submit" id="submitAnnouncement">
                <i class="fas fa-paper-plane"></i> Post Announcement
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteAnnouncementModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeDeleteAnnouncementModal">&times;</span>
        <div class="modal-body">
          <h2><i class="fas fa-exclamation-triangle"></i> Delete Announcement</h2>
          <p class="warning-text">Are you sure you want to delete this announcement? This action cannot be undone.</p>
          <input type="hidden" id="deleteAnnouncementId" value="">
          <div class="form-actions">
            <button type="button" class="btn-cancel" id="cancelDeleteAnnouncement">Cancel</button>
            <button type="button" class="btn-danger" id="confirmDeleteAnnouncement">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toastMessage">Success!</span>
    </div>

    <script type="module" src="firebase.js"></script>
    <script type="module" src="script.js"></script>
    <script type="module">
      import { logout } from "./script.js";
      import { auth, db } from "./firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { 
        doc, 
        onSnapshot, 
        collection, 
        addDoc, 
        updateDoc, 
        deleteDoc, 
        serverTimestamp,
        query,
        orderBy
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) logoutBtn.addEventListener("click", (e) => logout(e));
      
      let profileRealtimeUnsubscribe = null;
      let announcementsUnsubscribe = null;
      let currentUserRole = 'student';
      let isEditing = false;

      // Check if user is instructor
      function isInstructor() {
        return currentUserRole === 'instructor' || currentUserRole === 'teacher' || currentUserRole === 'admin';
      }

      // Show toast notification
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        if (!toast || !toastMessage) return;
        
        toastMessage.textContent = message;
        toast.className = `toast toast-${type}`;
        toast.style.display = 'flex';
        
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      }

      // Update header name
      function updateHeaderName() {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName) {
          headerUserName.textContent = userData.name || 'User';
        }
        
        // Update current user role
        currentUserRole = (userData.role || 'student').toLowerCase();
        
        // Show/hide instructor actions
        const instructorActions = document.getElementById('instructorActions');
        if (instructorActions) {
          instructorActions.style.display = isInstructor() ? 'block' : 'none';
        }
      }

      // Setup profile realtime listener
      function setupProfileRealtime() {
        onAuthStateChanged(auth, (user) => {
          if (!user) return;

          if (typeof profileRealtimeUnsubscribe === 'function') {
            profileRealtimeUnsubscribe();
            profileRealtimeUnsubscribe = null;
          }

          profileRealtimeUnsubscribe = onSnapshot(doc(db, 'users', user.uid), (userSnap) => {
            if (!userSnap.exists()) return;
            const profile = userSnap.data() || {};
            const localUser = JSON.parse(localStorage.getItem('userData') || '{}');
            const merged = {
              ...localUser,
              id: user.uid,
              name: profile.fullName || localUser.name || user.displayName || 'User',
              role: profile.role || localUser.role,
              course: profile.course || localUser.course
            };
            localStorage.setItem('userData', JSON.stringify(merged));
            updateHeaderName();
          }, (error) => {
            console.warn('Announcements profile realtime failed:', error?.message || error);
          });
        });
      }

      // Load announcements from Firestore with realtime updates
      function loadAnnouncements() {
        const announcementsList = document.getElementById('announcementsList');
        const emptyState = document.getElementById('emptyState');
        
        // Cancel previous listener
        if (typeof announcementsUnsubscribe === 'function') {
          announcementsUnsubscribe();
        }

        const announcementsRef = collection(db, 'announcements');
        const q = query(announcementsRef, orderBy('createdAt', 'desc'));

        announcementsUnsubscribe = onSnapshot(q, (snapshot) => {
          const announcements = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            announcements.push({
              id: doc.id,
              ...data,
              createdAt: data.createdAt ? data.createdAt.toDate() : new Date()
            });
          });

          // Clear current list
          announcementsList.innerHTML = '';

          if (announcements.length === 0) {
            emptyState.style.display = 'block';
            announcementsList.style.display = 'none';
          } else {
            emptyState.style.display = 'none';
            announcementsList.style.display = 'block';
            
            // Render announcements
            announcements.forEach(announcement => {
              const card = createAnnouncementCard(announcement);
              announcementsList.appendChild(card);
            });
          }
        }, (error) => {
          console.error('Error loading announcements:', error);
          announcementsList.innerHTML = `
            <div class="card error-card">
              <i class="fas fa-exclamation-circle"></i>
              <p>Failed to load announcements. Please try again later.</p>
            </div>
          `;
        });
      }

      // Create announcement card HTML
      function createAnnouncementCard(announcement) {
        const card = document.createElement('div');
        card.className = 'card announcement-card';
        card.dataset.id = announcement.id;

        const date = announcement.createdAt ? announcement.createdAt.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        }) : 'Unknown date';

        const iconMap = {
          'bell': 'fa-bell',
          'graduation-cap': 'fa-graduation-cap',
          'calendar-check': 'fa-calendar-check',
          'book': 'fa-book',
          'users': 'fa-users',
          'exclamation-triangle': 'fa-exclamation-triangle',
          'info-circle': 'fa-info-circle',
          'star': 'fa-star'
        };

        const iconClass = iconMap[announcement.icon] || 'fa-bell';
        const isInstructorUser = isInstructor();

        card.innerHTML = `
          <div class="announcement-header">
            <div class="announcement-icon">
              <i class="fas ${iconClass}"></i>
            </div>
            <div class="announcement-meta">
              <span class="announcement-date">${date}</span>
              <span class="announcement-category">${announcement.category || 'General'}</span>
            </div>
          </div>
          <h3>${announcement.title || 'Untitled'}</h3>
          <p>${announcement.message || ''}</p>
          <div class="announcement-footer">
            <span class="announcement-author">Posted by: ${announcement.authorName || 'Admin'}</span>
            ${isInstructorUser ? `
              <div class="announcement-actions">
                <button class="btn-edit-announcement" data-id="${announcement.id}" title="Edit">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn-delete-announcement" data-id="${announcement.id}" title="Delete">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            ` : ''}
            <button class="btn-read-more">Read More</button>
          </div>
        `;

        return card;
      }

      // Open announcement modal for creating/editing
      function openAnnouncementModal(announcement = null) {
        const modal = document.getElementById('announcementModal');
        const title = document.getElementById('announcementModalTitle');
        const form = document.getElementById('announcementForm');
        const idInput = document.getElementById('announcementId');
        const titleInput = document.getElementById('announcementTitle');
        const messageInput = document.getElementById('announcementMessage');
        const categorySelect = document.getElementById('announcementCategory');
        const iconSelect = document.getElementById('announcementIcon');
        const submitBtn = document.getElementById('submitAnnouncement');

        if (!modal) return;

        if (announcement) {
          // Edit mode
          isEditing = true;
          title.innerHTML = '<i class="fas fa-edit"></i> Edit Announcement';
          idInput.value = announcement.id;
          titleInput.value = announcement.title || '';
          messageInput.value = announcement.message || '';
          categorySelect.value = announcement.category || 'General';
          iconSelect.value = announcement.icon || 'bell';
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        } else {
          // Create mode
          isEditing = false;
          title.innerHTML = '<i class="fas fa-bullhorn"></i> New Announcement';
          form.reset();
          idInput.value = '';
          submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Announcement';
        }

        modal.style.display = 'block';
      }

      // Close announcement modal
      function closeAnnouncementModal() {
        const modal = document.getElementById('announcementModal');
        if (modal) {
          modal.style.display = 'none';
        }
        document.getElementById('announcementForm').reset();
        isEditing = false;
      }

      // Open delete confirmation modal
      function openDeleteModal(announcementId) {
        const modal = document.getElementById('deleteAnnouncementModal');
        const idInput = document.getElementById('deleteAnnouncementId');
        if (modal) {
          idInput.value = announcementId;
          modal.style.display = 'block';
        }
      }

      // Close delete confirmation modal
      function closeDeleteModal() {
        const modal = document.getElementById('deleteAnnouncementModal');
        if (modal) {
          modal.style.display = 'none';
        }
        document.getElementById('deleteAnnouncementId').value = '';
      }

      // Save announcement (create or update)
      async function saveAnnouncement(event) {
        event.preventDefault();
        
        const id = document.getElementById('announcementId').value;
        const title = document.getElementById('announcementTitle').value.trim();
        const message = document.getElementById('announcementMessage').value.trim();
        const category = document.getElementById('announcementCategory').value;
        const icon = document.getElementById('announcementIcon').value;
        
        if (!title || !message) {
          showToast('Please fill in all required fields', 'error');
          return;
        }

        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        
        const announcementData = {
          title,
          message,
          category,
          icon,
          authorId: userData.id || auth.currentUser?.uid,
          authorName: userData.name || 'Admin',
          updatedAt: serverTimestamp()
        };

        try {
          if (isEditing && id) {
            // Update existing announcement
            await updateDoc(doc(db, 'announcements', id), {
              ...announcementData,
              updatedAt: serverTimestamp()
            });
            showToast('Announcement updated successfully!');
          } else {
            // Create new announcement
            await addDoc(collection(db, 'announcements'), {
              ...announcementData,
              createdAt: serverTimestamp()
            });
            showToast('Announcement posted successfully!');
          }
          
          closeAnnouncementModal();
        } catch (error) {
          console.error('Error saving announcement:', error);
          showToast('Failed to save announcement. Please try again.', 'error');
        }
      }

      // Delete announcement
      async function deleteAnnouncement() {
        const id = document.getElementById('deleteAnnouncementId').value;
        
        if (!id) return;

        try {
          await deleteDoc(doc(db, 'announcements', id));
          showToast('Announcement deleted successfully!');
          closeDeleteModal();
        } catch (error) {
          console.error('Error deleting announcement:', error);
          showToast('Failed to delete announcement. Please try again.', 'error');
        }
      }

      // Get announcement by ID from Firestore
      async function getAnnouncementById(id) {
        const { getDoc } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
        const docSnap = await getDoc(doc(db, 'announcements', id));
        if (docSnap.exists()) {
          return { id: docSnap.id, ...docSnap.data() };
        }
        return null;
      }

      // Event Listeners
      document.addEventListener('DOMContentLoaded', () => {
        updateHeaderName();
        loadAnnouncements();
        setupProfileRealtime();

        // Add announcement button
        const addBtn = document.getElementById('addAnnouncementBtn');
        if (addBtn) {
          addBtn.addEventListener('click', () => openAnnouncementModal());
        }

        // Modal close buttons
        const closeModal = document.getElementById('closeAnnouncementModal');
        if (closeModal) {
          closeModal.addEventListener('click', closeAnnouncementModal);
        }

        const cancelBtn = document.getElementById('cancelAnnouncement');
        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeAnnouncementModal);
        }

        // Delete modal
        const closeDeleteModalBtn = document.getElementById('closeDeleteAnnouncementModal');
        if (closeDeleteModalBtn) {
          closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
        }

        const cancelDeleteBtn = document.getElementById('cancelDeleteAnnouncement');
        if (cancelDeleteBtn) {
          cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        }

        const confirmDeleteBtn = document.getElementById('confirmDeleteAnnouncement');
        if (confirmDeleteBtn) {
          confirmDeleteBtn.addEventListener('click', deleteAnnouncement);
        }

        // Form submission
        const form = document.getElementById('announcementForm');
        if (form) {
          form.addEventListener('submit', saveAnnouncement);
        }

        // Click outside modal to close
        window.addEventListener('click', (event) => {
          const modal = document.getElementById('announcementModal');
          if (event.target === modal) {
            closeAnnouncementModal();
          }
          
          const deleteModal = document.getElementById('deleteAnnouncementModal');
          if (event.target === deleteModal) {
            closeDeleteModal();
          }
        });

        // Delegated event listeners for edit/delete buttons
        document.addEventListener('click', async (event) => {
          // Edit button
          const editBtn = event.target.closest('.btn-edit-announcement');
          if (editBtn) {
            const id = editBtn.dataset.id;
            const announcement = await getAnnouncementById(id);
            if (announcement) {
              openAnnouncementModal(announcement);
            }
            return;
          }

          // Delete button
          const deleteBtn = event.target.closest('.btn-delete-announcement');
          if (deleteBtn) {
            const id = deleteBtn.dataset.id;
            openDeleteModal(id);
            return;
          }

          // Read more button
          const readMoreBtn = event.target.closest('.btn-read-more');
          if (readMoreBtn) {
            const card = readMoreBtn.closest('.announcement-card');
            const text = card?.querySelector('p');
            if (!text) return;

            const expanded = readMoreBtn.dataset.expanded === 'true';
            if (expanded) {
              text.style.maxHeight = '';
              text.style.overflow = '';
              readMoreBtn.textContent = 'Read More';
              readMoreBtn.dataset.expanded = 'false';
            } else {
              text.style.maxHeight = 'none';
              text.style.overflow = 'visible';
              readMoreBtn.textContent = 'Show Less';
              readMoreBtn.dataset.expanded = 'true';
            }
          }
        });
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (typeof profileRealtimeUnsubscribe === 'function') {
          profileRealtimeUnsubscribe();
        }
        if (typeof announcementsUnsubscribe === 'function') {
          announcementsUnsubscribe();
        }
      });
    </script>
  </body>
</html>
