<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0a1929" />
    <title>Announcements - Darkboard</title>
    <link rel="stylesheet" href="Darkboard.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Main Navigation -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <div class="nav-header">
        <a href="#" class="brand" id="dashboardLink">DARKBOARD</a>
      </div>
      <ul class="nav-list">
        <li><a href="#" class="nav-item" id="navDashboard"><i class="fas fa-th-large"></i><span>Dashboard</span></a></li>
        <li><a href="Subjects.html" class="nav-item"><i class="fas fa-book"></i><span>Subjects</span></a></li>
        <li><a href="Grades.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Grades</span></a></li>
        <li><a href="Schedule.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a></li>
        <li><a href="Announcements.html" class="nav-item active"><i class="fas fa-bell"></i><span>Announcements</span></a></li>
        <li><a href="Submissions.html" class="nav-item"><i class="fas fa-file-upload"></i><span>Submissions</span></a></li>
        <li><a href="Students.html" class="nav-item"><i class="fas fa-users"></i><span>Students</span></a></li>
        <li><a href="Profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a></li>
        <li><a href="Settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        <li><a href="Help.html" class="nav-item"><i class="fas fa-question-circle"></i><span>Help</span></a></li>
        <li><a href="#" id="logoutBtn" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
      </ul>
      <div class="nav-right">
        <div class="user-menu-right">
          <img src="Gemini_Generated_Image_g3iakg3iakg3iakg.png" alt="User avatar" class="user-avatar">
          <span id="headerUserName">Loading...</span>
        </div>
      </div>
      <div class="top-user-name" id="topUserName"></div>
    </nav>

    <!-- Main Content -->
    <main class="content">
      <div class="welcome-section">
        <div class="welcome-text">
          <h1><i class="fas fa-bullhorn"></i> Announcements</h1>
          <p>Stay updated with the latest news and announcements.</p>
        </div>
      </div>

      <!-- Post Announcement Button (Instructors Only) -->
      <section class="card" id="postSection" style="display: none;">
        <button class="btn btn-primary" id="postAnnouncementBtn">
          <i class="fas fa-plus"></i> Post New Announcement
        </button>
      </section>

      <!-- Filter Section -->
      <section class="card" aria-labelledby="filter-heading">
        <div class="card-header">
          <h2 id="filter-heading"><i class="fas fa-filter"></i> Filter Announcements</h2>
        </div>
        <div class="filter-controls">
          <div class="filter-group">
            <label for="categoryFilter">Category:</label>
            <select id="categoryFilter" class="filter-select">
              <option value="">All Categories</option>
              <option value="Academic">Academic</option>
              <option value="Events">Events</option>
              <option value="General">General</option>
              <option value="Urgent">Urgent</option>
            </select>
          </div>
          <button class="btn btn-primary" id="applyFilterBtn">
            <i class="fas fa-search"></i> Apply
          </button>
        </div>
      </section>

      <!-- Announcements List -->
      <div class="announcements-list" id="announcementsList">
        <div class="loading-indicator">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading announcements...</p>
        </div>
      </div>
    </main>

    <!-- Create/Edit Announcement Modal -->
    <div id="announcementModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle"><i class="fas fa-bullhorn"></i> Post Announcement</h2>
          <span class="close-modal" onclick="closeModal('announcementModal')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="announcementForm">
            <input type="hidden" id="announcementId">
            <div class="form-group">
              <label for="announcementTitle">Title *</label>
              <input type="text" id="announcementTitle" required placeholder="Enter announcement title">
            </div>
            <div class="form-group">
              <label for="announcementCategory">Category *</label>
              <select id="announcementCategory" required>
                <option value="">Select Category</option>
                <option value="Academic">Academic</option>
                <option value="Events">Events</option>
                <option value="General">General</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>
            <div class="form-group">
              <label for="announcementContent">Message *</label>
              <textarea id="announcementContent" rows="5" required placeholder="Enter your announcement message"></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal('announcementModal')">Cancel</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Post Announcement
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content modal-sm">
        <div class="modal-header">
          <h2><i class="fas fa-exclamation-triangle"></i> Delete Announcement</h2>
          <span class="close-modal" onclick="closeModal('deleteModal')">&times;</span>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this announcement?</p>
          <p id="deleteAnnouncementTitle" class="delete-title"></p>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Announcement Modal -->
    <div id="viewModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="viewTitle"></h2>
          <span class="close-modal" onclick="closeModal('viewModal')">&times;</span>
        </div>
        <div class="modal-body">
          <div class="view-meta" id="viewMeta"></div>
          <div class="view-content" id="viewContent"></div>
        </div>
      </div>
    </div>

    <script type="module" src="firebase.js"></script>
    <script type="module" src="script.js"></script>
    <script src="https://unpkg.com/scrollreveal"></script>
    <script type="module">
      import { logout } from "./script.js";
      import { auth, db } from "./firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { doc, getDoc, getDocs, collection, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      
      // Role check
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      const normalizedRole = (userData.role || '').toLowerCase();
      const isInstructor = normalizedRole === 'instructor' || normalizedRole === 'teacher' || normalizedRole === 'admin';
      
      // Set up dashboard link based on role
      const dashboardLink = document.getElementById('dashboardLink');
      const navDashboard = document.getElementById('navDashboard');
      if (isInstructor) {
        dashboardLink.href = 'InstructorDashboard.html';
        navDashboard.href = 'InstructorDashboard.html';
      } else {
        dashboardLink.href = 'index.html';
        navDashboard.href = 'index.html';
      }

      // Logout button
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) logoutBtn.addEventListener("click", (e) => logout(e));

      // Show post button for instructors
      const postSection = document.getElementById('postSection');
      const postAnnouncementBtn = document.getElementById('postAnnouncementBtn');
      if (isInstructor && postSection && postAnnouncementBtn) {
        postSection.style.display = 'block';
      }

      // All announcements
      let allAnnouncements = [];

      // Load announcements from Firestore
      async function loadAnnouncements() {
        const announcementsList = document.getElementById('announcementsList');
        if (!announcementsList) return;
        
        try {
          const announcementsRef = collection(db, 'announcements');
          const q = query(announcementsRef, orderBy('createdAt', 'desc'));
          
          const snapshot = await getDocs(q);
          allAnnouncements = [];
          
          snapshot.forEach(doc => {
            const data = doc.data();
            allAnnouncements.push({
              id: doc.id,
              title: data.title || 'Untitled',
              category: data.category || 'General',
              content: data.content || '',
              author: data.author || 'Unknown',
              authorId: data.authorId || '',
              createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
              targetAudience: data.targetAudience || 'all'
            });
          });
          
          renderAnnouncements(allAnnouncements);
          
        } catch (error) {
          console.log('Error loading announcements:', error.message);
          announcementsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-bullhorn"></i>
              <p>No announcements yet</p>
            </div>
          `;
        }
      }

      // Render announcements
      function renderAnnouncements(announcements) {
        const announcementsList = document.getElementById('announcementsList');
        if (!announcementsList) return;
        
        // Filter by category
        const categoryValue = document.getElementById('categoryFilter')?.value || '';
        let filtered = announcements;
        
        if (categoryValue) {
          filtered = filtered.filter(a => a.category === categoryValue);
        }
        
        if (filtered.length === 0) {
          announcementsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-bullhorn"></i>
              <p>No announcements found</p>
            </div>
          `;
          return;
        }
        
        announcementsList.innerHTML = filtered.map(announcement => {
          const date = announcement.createdAt ? announcement.createdAt.toLocaleDateString('en-US', { 
            year: 'numeric', month: 'long', day: 'numeric' 
          }) : 'Unknown date';
          
          const icon = getCategoryIcon(announcement.category);
          const canEdit = isInstructor && (announcement.authorId === auth.currentUser?.uid || announcement.authorId === userData.id);
          
          return `
            <div class="card announcement-card">
              <div class="announcement-header">
                <div class="announcement-icon">
                  <i class="fas fa-${icon}"></i>
                </div>
                <div class="announcement-meta">
                  <span class="announcement-date">${date}</span>
                  <span class="announcement-category">${announcement.category}</span>
                </div>
              </div>
              <h3>${announcement.title}</h3>
              <p>${truncateText(announcement.content, 150)}</p>
              <div class="announcement-footer">
                <span class="announcement-author">Posted by: ${announcement.author}</span>
                <div class="announcement-actions">
                  <button class="btn-read-more" onclick="viewAnnouncement('${announcement.id}')">Read More</button>
                  ${canEdit ? `
                  <button class="btn-icon" onclick="editAnnouncement('${announcement.id}')" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-icon btn-danger" onclick="confirmDeleteAnnouncement('${announcement.id}', '${announcement.title}')" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      function getCategoryIcon(category) {
        const icons = {
          'Academic': 'graduation-cap',
          'Events': 'calendar-check',
          'General': 'info-circle',
          'Urgent': 'exclamation-triangle'
        };
        return icons[category] || 'bullhorn';
      }

      function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
      }

      // Modal functions
      window.closeModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
      };

      // Post new announcement
      if (postAnnouncementBtn) {
        postAnnouncementBtn.addEventListener('click', () => {
          document.getElementById('modalTitle').innerHTML = '<i class="fas fa-bullhorn"></i> Post Announcement';
          document.getElementById('announcementId').value = '';
          document.getElementById('announcementForm').reset();
          document.getElementById('announcementModal').style.display = 'block';
        });
      }

      // Handle form submission
      const announcementForm = document.getElementById('announcementForm');
      if (announcementForm) {
        announcementForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const id = document.getElementById('announcementId').value;
          const title = document.getElementById('announcementTitle').value;
          const category = document.getElementById('announcementCategory').value;
          const content = document.getElementById('announcementContent').value;
          
          try {
            if (id) {
              // Update existing
              await updateDoc(doc(db, 'announcements', id), {
                title,
                category,
                content,
                updatedAt: serverTimestamp()
              });
              alert('Announcement updated successfully!');
            } else {
              // Create new
              await addDoc(collection(db, 'announcements'), {
                title,
                category,
                content,
                author: userData.name || 'Instructor',
                authorId: auth.currentUser?.uid || userData.id,
                targetAudience: 'all',
                createdAt: serverTimestamp()
              });
              alert('Announcement posted successfully!');
            }
            
            closeModal('announcementModal');
            announcementForm.reset();
            loadAnnouncements();
            
          } catch (error) {
            alert('Error: ' + error.message);
          }
        });
      }

      // Edit announcement
      window.editAnnouncement = function(id) {
        const announcement = allAnnouncements.find(a => a.id === id);
        if (!announcement) return;
        
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Announcement';
        document.getElementById('announcementId').value = id;
        document.getElementById('announcementTitle').value = announcement.title;
        document.getElementById('announcementCategory').value = announcement.category;
        document.getElementById('announcementContent').value = announcement.content;
        document.getElementById('announcementModal').style.display = 'block';
      };

      // View announcement
      window.viewAnnouncement = function(id) {
        const announcement = allAnnouncements.find(a => a.id === id);
        if (!announcement) return;
        
        const date = announcement.createdAt ? announcement.createdAt.toLocaleDateString('en-US', { 
          year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        }) : 'Unknown date';
        
        document.getElementById('viewTitle').textContent = announcement.title;
        document.getElementById('viewMeta').innerHTML = `
          <span class="announcement-date">${date}</span>
          <span class="announcement-category">${announcement.category}</span>
          <span class="announcement-author">Posted by: ${announcement.author}</span>
        `;
        document.getElementById('viewContent').innerHTML = `<p>${announcement.content}</p>`;
        document.getElementById('viewModal').style.display = 'block';
      };

      // Delete announcement
      let announcementToDelete = null;
      
      window.confirmDeleteAnnouncement = function(id, title) {
        announcementToDelete = { id, title };
        document.getElementById('deleteAnnouncementTitle').textContent = title;
        document.getElementById('deleteModal').style.display = 'block';
      };

      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async () => {
          if (!announcementToDelete) return;
          
          try {
            await deleteDoc(doc(db, 'announcements', announcementToDelete.id));
            alert('Announcement deleted successfully!');
            closeModal('deleteModal');
            loadAnnouncements();
          } catch (error) {
            alert('Error deleting: ' + error.message);
          }
          
          announcementToDelete = null;
        });
      }

      // Filter
      const applyFilterBtn = document.getElementById('applyFilterBtn');
      if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', () => renderAnnouncements(allAnnouncements));
      }

      // Close modals on outside click
      window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      };

      // Update header
      function updateHeaderName() {
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName && userData) {
          headerUserName.textContent = userData.name || 'User';
        }
      }

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        loadAnnouncements();
        updateHeaderName();
      });

      // ScrollReveal
      ScrollReveal().reveal(".announcement-card", {
        delay: 200,
        interval: 150,
        distance: '20px'
      });
    </script>
  </body>
</html>
